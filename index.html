<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ServiPDF Pro - Soluciones PDF Avanzadas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4338ca',
            secondary: '#16a34a',
            accent: '#dc2626',
            dark: '#1e293b',
            light: '#f8fafc'
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite'
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
    .dropZone.dragover { background-color: #eef6ff; }
    .feature-card { transition: all 0.3s ease; }
    .feature-card:hover { transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    .progress-bar { overflow: hidden; border-radius: 9999px; }
    .progress-fill { transition: width 0.3s ease; }
    .log-container { 
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f1f5f9;
    }
    .log-container::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    .log-container::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 9999px;
    }
    .log-container::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 9999px;
    }
    .log-container::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    .pulse-animation {
      display: inline-block;
      animation: pulse-slow;
    }
    .file-input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen pt-6 pb-12">
  <div class="max-w-6xl mx-auto px-4">
    <header class="text-center mb-12">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-primary/10 mb-4">
        <i class="fas fa-file-pdf text-3xl text-primary"></i>
      </div>
      <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-primary to-indigo-600 bg-clip-text text-transparent mb-2">
        ServiPDF Pro
      </h1>
      <p class="text-gray-600 max-w-2xl mx-auto text-lg">
        Soluciones avanzadas para documentos PDF en tu navegador - Sin subidas a servidores, 100% privado
      </p>
    </header>

    <div class="grid md:grid-cols-2 gap-6 mb-12">
      <!-- 1. UNIR PDFs + título IZQUIERDA -->
      <div class="feature-card bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-4">
          <h2 class="text-white text-xl font-bold flex items-center">
            <i class="fas fa-align-left mr-3"></i>
            Unir PDFs con título a la izquierda
          </h2>
        </div>
        <div class="p-5">
          <div class="dropZone border-2 border-dashed border-blue-400 rounded-xl p-6 text-center mb-5 cursor-pointer transition-colors" id="zoneLeft">
            <i class="fas fa-cloud-upload-alt text-blue-500 text-4xl mb-3 pulse-animation"></i>
            <label for="pdfLeft" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-xl inline-block cursor-pointer transition-colors shadow-md">
              <i class="fas fa-file-import mr-2"></i>Seleccionar archivos PDF
            </label>
            <p class="text-gray-500 mt-2 text-sm">o arrastra tus archivos aquí</p>
            <input type="file" id="pdfLeft" accept="application/pdf" multiple class="file-input">
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between text-sm mb-1">
              <span class="font-medium">Progreso</span>
              <span id="pctLeft" class="text-gray-600 font-medium">0%</span>
            </div>
            <div class="progress-bar bg-gray-200 h-2.5 rounded-full overflow-hidden">
              <div id="progLeft" class="progress-fill h-full bg-green-500 rounded-full" style="width: 0%"></div>
            </div>
          </div>
          
          <button id="btnLeft" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl mb-4 transition-colors shadow-md flex items-center justify-center">
            <i class="fas fa-download mr-2"></i>Descargar PDF Unido
          </button>
          
          <div id="logLeft" class="log-container bg-gray-50 border border-gray-200 rounded-lg p-3 h-32 overflow-y-auto text-left text-sm font-mono"></div>
        </div>
      </div>

      <!-- 2. UNIR PDFs + título CENTRADO -->
      <div class="feature-card bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="bg-gradient-to-r from-emerald-500 to-cyan-600 p-4">
          <h2 class="text-white text-xl font-bold flex items-center">
            <i class="fas fa-align-center mr-3"></i>
            Unir PDFs con título centrado
          </h2>
        </div>
        <div class="p-5">
          <div class="dropZone border-2 border-dashed border-emerald-400 rounded-xl p-6 text-center mb-5 cursor-pointer transition-colors" id="zoneCenter">
            <i class="fas fa-cloud-upload-alt text-emerald-500 text-4xl mb-3 pulse-animation"></i>
            <label for="pdfCenter" class="bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-3 px-6 rounded-xl inline-block cursor-pointer transition-colors shadow-md">
              <i class="fas fa-file-import mr-2"></i>Seleccionar archivos PDF
            </label>
            <p class="text-gray-500 mt-2 text-sm">o arrastra tus archivos aquí</p>
            <input type="file" id="pdfCenter" accept="application/pdf" multiple class="file-input">
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between text-sm mb-1">
              <span class="font-medium">Progreso</span>
              <span id="pctCenter" class="text-gray-600 font-medium">0%</span>
            </div>
            <div class="progress-bar bg-gray-200 h-2.5 rounded-full overflow-hidden">
              <div id="progCenter" class="progress-fill h-full bg-green-500 rounded-full" style="width: 0%"></div>
            </div>
          </div>
          
          <button id="btnCenter" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl mb-4 transition-colors shadow-md flex items-center justify-center">
            <i class="fas fa-download mr-2"></i>Descargar PDF Unido
          </button>
          
          <div id="logCenter" class="log-container bg-gray-50 border border-gray-200 rounded-lg p-3 h-32 overflow-y-auto text-left text-sm font-mono"></div>
        </div>
      </div>

      <!-- 3. CONVERTIR TODO A PDF + UNIR -->
      <div class="feature-card bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="bg-gradient-to-r from-purple-500 to-pink-600 p-4">
          <h2 class="text-white text-xl font-bold flex items-center">
            <i class="fas fa-sync-alt mr-3"></i>
            Convertir y unir múltiples formatos
          </h2>
        </div>
        <div class="p-5">
          <div class="dropZone border-2 border-dashed border-purple-400 rounded-xl p-6 text-center mb-5 cursor-pointer transition-colors" id="zoneAll">
            <i class="fas fa-cloud-upload-alt text-purple-500 text-4xl mb-3 pulse-animation"></i>
            <label for="allFiles" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-xl inline-block cursor-pointer transition-colors shadow-md">
              <i class="fas fa-file-import mr-2"></i>Seleccionar archivos
            </label>
            <p class="text-gray-500 mt-2 text-sm">PDF, Word, Imágenes, Texto y más</p>
            <input type="file" id="allFiles" multiple class="file-input">
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between text-sm mb-1">
              <span class="font-medium">Progreso</span>
              <span id="pctAll" class="text-gray-600 font-medium">0%</span>
            </div>
            <div class="progress-bar bg-gray-200 h-2.5 rounded-full overflow-hidden">
              <div id="progAll" class="progress-fill h-full bg-green-500 rounded-full" style="width: 0%"></div>
            </div>
          </div>
          
          <button id="btnAll" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl mb-4 transition-colors shadow-md flex items-center justify-center">
            <i class="fas fa-download mr-2"></i>Descargar Todo en PDF
          </button>
          
          <div id="logAll" class="log-container bg-gray-50 border border-gray-200 rounded-lg p-3 h-32 overflow-y-auto text-left text-sm font-mono"></div>
        </div>
      </div>

      <!-- 4. EXTRAER CARPETA NUMERADA → PDFs -->
      <div class="feature-card bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="bg-gradient-to-r from-orange-500 to-amber-600 p-4">
          <h2 class="text-white text-xl font-bold flex items-center">
            <i class="fas fa-images mr-3"></i>
            Carpeta numerada a PDFs
          </h2>
        </div>
        <div class="p-5">
          <div class="dropZone border-2 border-dashed border-orange-400 rounded-xl p-6 text-center mb-5 cursor-pointer transition-colors" id="zoneNum">
            <i class="fas fa-folder-open text-orange-500 text-4xl mb-3 pulse-animation"></i>
            <label for="numFolder" class="bg-orange-600 hover:bg-orange-700 text-white font-medium py-3 px-6 rounded-xl inline-block cursor-pointer transition-colors shadow-md">
              <i class="fas fa-folder mr-2"></i>Seleccionar carpeta
            </label>
            <p class="text-gray-500 mt-2 text-sm">Archivos serán convertidos y numerados</p>
            <input type="file" id="numFolder" webkitdirectory multiple class="file-input">
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between text-sm mb-1">
              <span class="font-medium">Progreso</span>
              <span id="pctNum" class="text-gray-600 font-medium">0%</span>
            </div>
            <div class="progress-bar bg-gray-200 h-2.5 rounded-full overflow-hidden">
              <div id="progNum" class="progress-fill h-full bg-green-500 rounded-full" style="width: 0%"></div>
            </div>
          </div>
          
          <button id="btnNum" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl mb-4 transition-colors shadow-md flex items-center justify-center">
            <i class="fas fa-download mr-2"></i>Descargar como ZIP
          </button>
          
          <div id="logNum" class="log-container bg-gray-50 border border-gray-200 rounded-lg p-3 h-32 overflow-y-auto text-left text-sm font-mono"></div>
        </div>
      </div>

      <!-- 5. RENOMBRAR POR PATRÓN REGEX -->
      <div class="feature-card bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="bg-gradient-to-r from-rose-500 to-fuchsia-600 p-4">
          <h2 class="text-white text-xl font-bold flex items-center">
            <i class="fas fa-magic mr-3"></i>
            Renombrar con expresiones regulares
          </h2>
        </div>
        <div class="p-5">
          <div class="dropZone border-2 border-dashed border-rose-400 rounded-xl p-6 text-center mb-5 cursor-pointer transition-colors" id="zoneRename">
            <i class="fas fa-magic text-rose-500 text-4xl mb-3 pulse-animation"></i>
            <label for="renameFolder" class="bg-rose-600 hover:bg-rose-700 text-white font-medium py-3 px-6 rounded-xl inline-block cursor-pointer transition-colors shadow-md">
              <i class="fas fa-folder mr-2"></i>Seleccionar carpeta
            </label>
            <p class="text-gray-500 mt-2 text-sm">Renombra archivos masivamente</p>
            <input type="file" id="renameFolder" webkitdirectory multiple class="file-input">
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between text-sm mb-1">
              <span class="font-medium">Progreso</span>
              <span id="pctRename" class="text-gray-600 font-medium">0%</span>
            </div>
            <div class="progress-bar bg-gray-200 h-2.5 rounded-full overflow-hidden">
              <div id="progRename" class="progress-fill h-full bg-green-500 rounded-full" style="width: 0%"></div>
            </div>
          </div>
          
          <div class="space-y-3 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Patrón regex:</label>
              <input type="text" id="regexIn" value="^(.+?)\s*-\s*(\d{4}-\d{2}-\d{2}\s+\d{4}(?:-\d+)?)(\.eml)$" 
                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nuevo formato (usa $1, $2…):</label>
              <input type="text" id="replaceFmt" value="$2.$1$3" 
                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-transparent">
            </div>
          </div>
          
          <button id="btnRename" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl mb-4 transition-colors shadow-md flex items-center justify-center">
            <i class="fas fa-download mr-2"></i>Descargar carpeta renombrada
          </button>
          
          <div id="logRename" class="log-container bg-gray-50 border border-gray-200 rounded-lg p-3 h-32 overflow-y-auto text-left text-sm font-mono"></div>
        </div>
      </div>

      <!-- 6. EXTRAIR .eml → EXCEL -->
      <div class="feature-card bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="bg-gradient-to-r from-cyan-500 to-teal-600 p-4">
          <h2 class="text-white text-xl font-bold flex items-center">
            <i class="fas fa-envelope mr-3"></i>
            Extraer correos .eml a Excel
          </h2>
        </div>
        <div class="p-5">
          <div class="dropZone border-2 border-dashed border-cyan-400 rounded-xl p-6 text-center mb-5 cursor-pointer transition-colors" id="zoneEml">
            <i class="fas fa-envelope-open-text text-cyan-500 text-4xl mb-3 pulse-animation"></i>
            <label for="emlFolder" class="bg-cyan-600 hover:bg-cyan-700 text-white font-medium py-3 px-6 rounded-xl inline-block cursor-pointer transition-colors shadow-md">
              <i class="fas fa-folder mr-2"></i>Seleccionar carpeta .eml
            </label>
            <p class="text-gray-500 mt-2 text-sm">Convierte correos a formato Excel</p>
            <input type="file" id="emlFolder" webkitdirectory multiple class="file-input">
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between text-sm mb-1">
              <span class="font-medium">Progreso</span>
              <span id="pctEml" class="text-gray-600 font-medium">0%</span>
            </div>
            <div class="progress-bar bg-gray-200 h-2.5 rounded-full overflow-hidden">
              <div id="progEml" class="progress-fill h-full bg-green-500 rounded-full" style="width: 0%"></div>
            </div>
          </div>
          
          <button id="btnEml" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl mb-4 transition-colors shadow-md flex items-center justify-center">
            <i class="fas fa-download mr-2"></i>Descargar Excel
          </button>
          
          <div id="logEml" class="log-container bg-gray-50 border border-gray-200 rounded-lg p-3 h-32 overflow-y-auto text-left text-sm font-mono"></div>
        </div>
      </div>
    </div>

    <footer class="text-center mt-8 pt-8 border-t border-gray-200 text-gray-500">
      <p class="mb-2">ServiPDF Pro &copy; 2025 - Procesamiento 100% en tu navegador</p>
      <p class="text-sm">Ningún archivo se envía a servidores externos. Tu privacidad es nuestra prioridad.</p>
    </footer>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
  /* ---------- helpers ---------- */
  const $ = id => document.getElementById(id);
  function log(boxId, txt){
    const el = $(boxId);
    el.insertAdjacentHTML('beforeend', `<div>${txt}</div>`);
    el.scrollTop = el.scrollHeight;
  }
  function downloadBlob(blob, name){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    }, 0);
  }
  function setProg(barId, pctId, pct){
    $(barId).style.width = pct + '%';
    $(pctId).textContent = pct + '%';
  }

  /* ---------- zona común (click + drag) ---------- */
  function setupZone(zoneId, inputId, onFiles){
    const zone = $(zoneId);
    const inp  = $(inputId);

    // click normal
    inp.addEventListener('change', () => onFiles(inp.files));

    // drag
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
    zone.addEventListener('drop', e => {
      e.preventDefault(); zone.classList.remove('dragover');
      if (e.dataTransfer.items) {
        const files = [];
        for (let i = 0; i < e.dataTransfer.items.length; i++) {
          if (e.dataTransfer.items[i].webkitGetAsEntry) {
            const entry = e.dataTransfer.items[i].webkitGetAsEntry();
            if (entry.isFile) {
              entry.file(file => files.push(file));
            }
          }
        }
        if (files.length > 0) {
          const dt = new DataTransfer();
          files.forEach(file => dt.items.add(file));
          inp.files = dt.files;
          onFiles(dt.files);
        }
      } else {
        const files = e.dataTransfer.files;
        inp.files = files;
        onFiles(files);
      }
    });
  }

  /* ---------- 1. LEFT ---------- */
  let bufLeft = [];
  setupZone('zoneLeft', 'pdfLeft', async files => {
    bufLeft = []; log('logLeft', ''); setProg('progLeft', 'pctLeft', 0);
    const total = files.length;
    for (let i = 0; i < total; i++){
      const f = files[i];
      const bytes = await f.arrayBuffer();
      const stamped = await stampPdf(bytes, f.name.replace(/\.pdf$/i, ''), 'left');
      bufLeft.push(stamped);
      setProg('progLeft', 'pctLeft', Math.round((i + 1) / total * 100));
      log('logLeft', `✔ ${f.name}`);
    }
    log('logLeft', '<span class="text-green-600 font-medium">Listo. Pulsa DESCARGAR.</span>');
  });
  $('#btnLeft').addEventListener('click', async () => {
    if (!bufLeft.length) { alert('Primero elige o arrastra PDFs'); return; }
    const merged = await mergePdfs(bufLeft);
    downloadBlob(merged, 'UNIDO_ROJO_IZQ.pdf');
    log('logLeft', '<span class="text-green-700 font-bold">✅ Descarga iniciada</span>');
  });

  /* ---------- 2. CENTER ---------- */
  let bufCenter = [];
  setupZone('zoneCenter', 'pdfCenter', async files => {
    bufCenter = []; log('logCenter', ''); setProg('progCenter', 'pctCenter', 0);
    const total = files.length;
    for (let i = 0; i < total; i++){
      const f = files[i];
      const bytes = await f.arrayBuffer();
      const stamped = await stampPdf(bytes, f.name.replace(/\.pdf$/i, ''), 'center');
      bufCenter.push(stamped);
      setProg('progCenter', 'pctCenter', Math.round((i + 1) / total * 100));
      log('logCenter', `✔ ${f.name}`);
    }
    log('logCenter', '<span class="text-green-600 font-medium">Listo. Pulsa DESCARGAR.</span>');
  });
  $('#btnCenter').addEventListener('click', async () => {
    if (!bufCenter.length) { alert('Primero elige o arrastra PDFs'); return; }
    const merged = await mergePdfs(bufCenter);
    downloadBlob(merged, 'UNIDO_ROJO_CENTRADO.pdf');
    log('logCenter', '<span class="text-green-700 font-bold">✅ Descarga iniciada</span>');
  });

  /* ---------- 3. ALL TO PDF ---------- */
  let bufAll = [];
  setupZone('zoneAll', 'allFiles', async files => {
    bufAll = []; log('logAll', ''); setProg('progAll', 'pctAll', 0);
    const total = files.length;
    for (let i = 0; i < total; i++){
      const f = files[i];
      const ext = f.name.split('.').pop().toLowerCase();
      let pdfBytes;
      try {
        if (ext === 'pdf') {
          pdfBytes = await f.arrayBuffer();
        } else if (['docx'].includes(ext)) {
          pdfBytes = await word2pdf(f);
        } else if (['jpg', 'jpeg', 'png'].includes(ext)) {
          pdfBytes = await img2pdf(f);
        } else if (ext === 'txt') {
          pdfBytes = await txt2pdf(f);
        } else {
          log('logAll', `<span class="text-yellow-600">⚠ Saltado: ${f.name} (formato no soportado)</span>`);
          continue;
        }
        const stamped = await stampPdf(pdfBytes, f.name.replace(/\.[^.]+$/i, ''), 'center');
        bufAll.push(stamped);
      } catch (err) {
        log('logAll', `<span class="text-red-600">⚠ Error en ${f.name}: ${err.message}</span>`);
      }
      setProg('progAll', 'pctAll', Math.round((i + 1) / total * 100));
      log('logAll', `✔ ${f.name}`);
    }
    log('logAll', '<span class="text-green-600 font-medium">Listo. Pulsa DESCARGAR.</span>');
  });
  $('#btnAll').addEventListener('click', async () => {
    if (!bufAll.length) { alert('Primero elige o arrastra archivos'); return; }
    const merged = await mergePdfs(bufAll);
    downloadBlob(merged, 'TODO_UNIDO_ROJO.pdf');
    log('logAll', '<span class="text-green-700 font-bold">✅ Descarga iniciada</span>');
  });

  /* ---------- 4. CARPETA NUMERADA ---------- */
  let bufNum = [];
  setupZone('zoneNum', 'numFolder', async files => {
    bufNum = []; log('logNum', ''); setProg('progNum', 'pctNum', 0);
    const sorted = Array.from(files).sort((a, b) =>
      a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'})
    );
    const total = sorted.length;
    for (let i = 0; i < total; i++){
      const f = sorted[i];
      const ext = f.name.split('.').pop().toLowerCase();
      let pdfBytes;
      try {
        if (ext === 'pdf') {
          pdfBytes = await f.arrayBuffer();
        } else if (['docx'].includes(ext)) {
          pdfBytes = await word2pdf(f);
        } else if (['jpg', 'jpeg', 'png'].includes(ext)) {
          pdfBytes = await img2pdf(f);
        } else if (ext === 'txt') {
          pdfBytes = await txt2pdf(f);
        } else {
          log('logNum', `<span class="text-yellow-600">⚠ Saltado: ${f.name}</span>`);
          continue;
        }
        const newName = f.name.replace(/\.[^.]+$/, '.pdf');
        bufNum.push({name: newName, blob: new Blob([pdfBytes], {type: 'application/pdf'})});
      } catch (err) {
        log('logNum', `<span class="text-red-600">⚠ Error en ${f.name}: ${err.message}</span>`);
      }
      setProg('progNum', 'pctNum', Math.round((i + 1) / total * 100));
      log('logNum', `✔ ${f.name}`);
    }
    const zip = new JSZip();
    bufNum.forEach(f => zip.file(f.name, f.blob));
    const content = await zip.generateAsync({type: 'blob'});
    downloadBlob(content, 'CARPETA_NUMERADA_PDFs.zip');
    log('logNum', '<span class="text-green-700 font-bold">✅ ZIP descargado</span>');
  });

  /* ---------- 5. RENOMBRAR POR PATRÓN ---------- */
  let renameFiles = [];
  setupZone('zoneRename', 'renameFolder', async files => {
    renameFiles = Array.from(files);
    log('logRename', '<span class="text-blue-600">Archivos cargados. Configura el patrón y pulsa DESCARGAR.</span>'); 
    setProg('progRename', 'pctRename', 0);
  });

  $('#btnRename').addEventListener('click', async () => {
    if (renameFiles.length === 0) { alert('Primero elige o arrastra archivos'); return; }
    
    const pattern = $('#regexIn').value.trim();
    const repl = $('#replaceFmt').value.trim();
    let regex;
    try { 
      regex = new RegExp(pattern, 'i'); 
    } catch (e) {
      log('logRename', `<span class="text-red-600">❌ Regex inválido: ${e.message}</span>`);
      return;
    }
    
    const zip = new JSZip();
    const total = renameFiles.length;
    let processed = 0;
    
    for (let i = 0; i < total; i++){
      const f = renameFiles[i];
      const name = f.name;
      const m = name.match(regex);
      if (!m) { 
        log('logRename', `<span class="text-yellow-600">⚠ Sin coincidencia: ${name}</span>`); 
        processed++;
        setProg('progRename', 'pctRename', Math.round(processed / total * 100));
        continue; 
      }
      
      let nuevo = repl;
      m.forEach((g, idx) => {
        if (idx > 0) {
          nuevo = nuevo.replaceAll(`$${idx}`, g || '');
        }
      });
      
      try {
        const content = await f.arrayBuffer();
        zip.file(nuevo, content);
        log('logRename', `✔ ${name} → ${nuevo}`);
      } catch (e) {
        log('logRename', `<span class="text-red-600">⚠ Error procesando ${name}: ${e.message}</span>`);
      }
      
      processed++;
      setProg('progRename', 'pctRename', Math.round(processed / total * 100));
    }
    
    const blob = await zip.generateAsync({type: 'blob'});
    downloadBlob(blob, 'CARPETA_RENOMBRADA.zip');
    log('logRename', '<span class="text-green-700 font-bold">✅ ZIP descargado</span>');
  });

  /* ---------- 6. EXTRAIR .eml → EXCEL ---------- */
  setupZone('zoneEml', 'emlFolder', async files => {
    log('logEml', ''); setProg('progEml', 'pctEml', 0);
    const validFiles = Array.from(files).filter(f => f.name.toLowerCase().endsWith('.eml'));
    if (validFiles.length === 0) {
      log('logEml', '<span class="text-yellow-600">⚠ No se encontraron archivos .eml en la carpeta seleccionada</span>');
      return;
    }
    
    try {
      const [mailparser, xlsx] = await Promise.all([
        import('https://cdn.skypack.dev/mailparser@3.4.6'),
        import('https://cdn.skypack.dev/xlsx@0.18.5')
      ]);
      
      const rows = [];
      const total = validFiles.length;
      
      for (let i = 0; i < total; i++){
        const f = validFiles[i];
        try {
          const raw = await f.text();
          const msg = await mailparser.simpleParser(raw);
          rows.push({
            'Fecha': msg.date ? new Date(msg.date).toLocaleString('es-ES') : '',
            'Remitente': msg.from?.text || '',
            'Asunto': msg.subject || '',
            'Destinatario': Array.isArray(msg.to) ? msg.to.map(t => t.text).join('; ') : (msg.to?.text || ''),
            'Cuerpo de mail': (msg.text || '').replace(/\s+/g, ' ').substring(0, 32767),
            'Adjuntos': msg.attachments?.map(a => a.filename).join('; ') || ''
          });
          log('logEml', `✔ ${f.name}`);
        } catch (e) {
          log('logEml', `<span class="text-red-600">⚠ Error en ${f.name}: ${e.message}</span>`);
        }
        setProg('progEml', 'pctEml', Math.round((i + 1) / total * 100));
      }
      
      if (!rows.length) { 
        log('logEml', '<span class="text-red-600">❌ No se pudo procesar ningún correo</span>');
        return; 
      }
      
      const ws = xlsx.utils.json_to_sheet(rows);
      const wb = xlsx.utils.book_new();
      xlsx.utils.book_append_sheet(wb, ws, 'Mails');
      const blob = xlsx.write(wb, {bookType: 'xlsx', type: 'blob'});
      downloadBlob(blob, 'Mails_desde_EML.xlsx');
      log('logEml', '<span class="text-green-700 font-bold">✅ Excel descargado</span>');
    } catch (e) {
      log('logEml', `<span class="text-red-600">❌ Error cargando librerías: ${e.message}</span>`);
      log('logEml', '<span class="text-yellow-600">ℹ️ Por favor, actualiza tu navegador para esta función</span>');
    }
  });

  /* ---------- core ---------- */
  async function stampPdf(pdfBytes, texto, align) {
    const pdf = await PDFLib.PDFDocument.load(pdfBytes);
    const font = await pdf.embedFont(PDFLib.StandardFonts.HelveticaBold);
    const txt = texto.toUpperCase().substring(0, 40);
    const fontSize = 10;
    const pages = pdf.getPages();
    pages.forEach(page => {
      const {width} = page.getSize();
      const textWidth = font.widthOfTextAtSize(txt, fontSize);
      const x = (align === 'left') ? 30 : (width - textWidth) / 2;
      page.drawText(txt, {x, y: page.getHeight() - 30, size: fontSize, font, color: PDFLib.rgb(1, 0, 0)});
    });
    return await pdf.save();
  }
  
  async function mergePdfs(arrBytes) {
    const merged = await PDFLib.PDFDocument.create();
    for (const bytes of arrBytes) {
      const doc = await PDFLib.PDFDocument.load(bytes);
      const copiedPages = await merged.copyPages(doc, doc.getPageIndices());
      copiedPages.forEach((page) => merged.addPage(page));
    }
    return new Blob([await merged.save()], {type: 'application/pdf'});
  }
  
  /* ---- conversores simples ---- */
  async function word2pdf(f) {
    throw new Error("Conversión de Word no soportada en esta versión. Usa archivos PDF directamente.");
  }
  
  async function img2pdf(f) {
    const img = await f.arrayBuffer();
    const pdf = await PDFLib.PDFDocument.create();
    let imgObj;
    const ext = f.name.split('.').pop().toLowerCase();
    
    try {
      if (ext === 'png') {
        imgObj = await pdf.embedPng(img);
      } else {
        imgObj = await pdf.embedJpg(img);
      }
    } catch (e) {
      throw new Error(`Formato de imagen no soportado: ${ext}`);
    }
    
    const page = pdf.addPage([imgObj.width, imgObj.height]);
    page.drawImage(imgObj, {x: 0, y: 0, width: imgObj.width, height: imgObj.height});
    return await pdf.save();
  }
  
  async function txt2pdf(f) {
    const text = await f.text();
    const pdf = await PDFLib.PDFDocument.create();
    const font = await pdf.embedFont(PDFLib.StandardFonts.Helvetica);
    const fontSize = 12;
    const lineHeight = fontSize * 1.5;
    const margin = 50;
    
    let page = pdf.addPage();
    let y = page.getHeight() - margin;
    
    const lines = text.split('\n');
    for (const line of lines) {
      if (y < margin + fontSize) {
        page = pdf.addPage();
        y = page.getHeight() - margin;
      }
      
      page.drawText(line, {
        x: margin,
        y: y,
        size: fontSize,
        font: font,
        color: PDFLib.rgb(0, 0, 0)
      });
      
      y -= lineHeight;
    }
    
    return await pdf.save();
  }
  </script>
</body>
</html>
