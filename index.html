<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>ServiPDF ‚Äì Web</title>
  <style>
    body{font-family:system-ui;text-align:center;margin-top:2rem;background:#fafafa}
    h1{color:#c00}
    .box{background:#fff;border:1px solid #ddd;border-radius:8px;margin:1rem auto;padding:1.5rem;width:90%;max-width:700px}
    .log{height:110px;overflow:auto;text-align:left;border:1px solid #ccc;padding:.5rem;background:#fff;font-size:.9rem;margin-top:.5rem}
    .btn{font-size:1.25rem;padding:.7rem 1.4rem;min-width:220px;margin:.4rem;border:none;border-radius:6px;cursor:pointer;color:#fff}
    .azul{background:#007bff}
    .verde{background:#28a745}
    /* input invisible pero funcional */
    input[type=file]{opacity:0;width:0;height:0;position:absolute}
    /* l√≠nea discontinua azul gruesa */
    .dropZone{border:3px dashed #007bff;border-radius:6px;padding:1rem;margin:.5rem 0;transition:.2s}
    .dropZone.dragover{background:#eef6ff}
    /* barra de progreso */
    .barra{height:14px;background:#e0e0e0;border-radius:7px;overflow:hidden;margin:.3rem 0}
    .progreso{height:100%;background:#28a745;width:0%;transition:width .2s}
    .porcentaje{font-size:.85rem;color:#555}
  </style>
</head>
<body>
  <h1>ServiPDF ‚Äì Web</h1>

  <!-- 1. UNIR PDFs + t√≠tulo IZQUIERDA -->
  <div class="box">
    <h2>1) Unir PDFs y poner t√≠tulo a la IZQUIERDA</h2>
    <div class="dropZone" id="zoneLeft">
      <label for="pdfLeft" class="btn azul">üìÅ Elegir archivos</label>
      <span style="margin-left:1rem">o arrastra aqu√≠</span>
      <input type="file" id="pdfLeft" accept="application/pdf" multiple>
      <div class="barra"><div class="progreso" id="progLeft"></div></div>
      <div class="porcentaje" id="pctLeft">0 %</div>
    </div>
    <button id="btnLeft" class="btn verde">‚¨áÔ∏è Descargar UNIDO (izq)</button>
    <div id="logLeft" class="log"></div>
  </div>

  <!-- 2. UNIR PDFs + t√≠tulo CENTRADO -->
  <div class="box">
    <h2>2) Unir PDFs y poner t√≠tulo CENTRADO</h2>
    <div class="dropZone" id="zoneCenter">
      <label for="pdfCenter" class="btn azul">üìÅ Elegir archivos</label>
      <span style="margin-left:1rem">o arrastra aqu√≠</span>
      <input type="file" id="pdfCenter" accept="application/pdf" multiple>
      <div class="barra"><div class="progreso" id="progCenter"></div></div>
      <div class="porcentaje" id="pctCenter">0 %</div>
    </div>
    <button id="btnCenter" class="btn verde">‚¨áÔ∏è Descargar UNIDO (centro)</button>
    <div id="logCenter" class="log"></div>
  </div>

  <!-- 3. CONVERTIR TODO A PDF + UNIR -->
  <div class="box">
    <h2>3) Convertir TODO a PDF y unir con t√≠tulo</h2>
    <div class="dropZone" id="zoneAll">
      <label for="allFiles" class="btn azul">üìÅ Elegir archivos</label>
      <span style="margin-left:1rem">o arrastra aqu√≠</span>
      <input type="file" id="allFiles" multiple>
      <div class="barra"><div class="progreso" id="progAll"></div></div>
      <div class="porcentaje" id="pctAll">0 %</div>
    </div>
    <button id="btnAll" class="btn verde">‚¨áÔ∏è Descargar TODO (PDF unido)</button>
    <div id="logAll" class="log"></div>
  </div>

  <!-- 4. EXTRAER CARPETA NUMERADA ‚Üí PDFs -->
  <div class="box">
    <h2>4) Extraer carpeta numerada ‚Üí PDFs</h2>
    <div class="dropZone" id="zoneNum">
      <label for="numFolder" class="btn azul">üìÅ Elegir carpeta numerada</label>
      <span style="margin-left:1rem">o arrastra aqu√≠</span>
      <input type="file" id="numFolder" webkitdirectory multiple>
      <div class="barra"><div class="progreso" id="progNum"></div></div>
      <div class="porcentaje" id="pctNum">0 %</div>
    </div>
    <button id="btnNum" class="btn verde">‚¨áÔ∏è Descargar PDFs numerados (ZIP)</button>
    <div id="logNum" class="log"></div>
  </div>

  <!-- 5. RENOMBRAR POR PATR√ìN REGEX -->
  <div class="box">
    <h2>5) Renombrar archivos de carpeta (regex)</h2>
    <div class="dropZone" id="zoneRename">
      <label for="renameFolder" class="btn azul">üìÅ Elegir carpeta</label>
      <span style="margin-left:1rem">o arrastra aqu√≠</span>
      <input type="file" id="renameFolder" webkitdirectory multiple>
      <div class="barra"><div class="progreso" id="progRename"></div></div>
      <div class="porcentaje" id="pctRename">0 %</div>
    </div>
    <label>Patr√≥n regex:
      <input type="text" id="regexIn" value="^(.+?)\s*-\s*(\d{4}-\d{2}-\d{2}\s+\d{4}(?:-\d+)?)(\.eml)$" style="width:90%">
    </label><br>
    <label>Nuevo formato (usa $1, $2‚Ä¶):
      <input type="text" id="replaceFmt" value="$2.$1$3" style="width:90%">
    </label><br><br>
    <button id="btnRename" class="btn verde">‚¨áÔ∏è Descargar carpeta renombrada (ZIP)</button>
    <div id="logRename" class="log"></div>
  </div>

  <!-- 6. EXTRAIR .eml ‚Üí EXCEL (columnas exactas) -->
  <div class="box">
    <h2>6) Extraer mails .eml ‚Üí Excel</h2>
    <div class="dropZone" id="zoneEml">
      <label for="emlFolder" class="btn azul">üìÅ Carpeta con .eml</label>
      <span style="margin-left:1rem">o arrastra aqu√≠</span>
      <input type="file" id="emlFolder" webkitdirectory multiple>
      <div class="barra"><div class="progreso" id="progEml"></div></div>
      <div class="porcentaje" id="pctEml">0 %</div>
    </div>
    <button id="btnEml" class="btn verde">‚¨áÔ∏è Descargar Excel</button>
    <div id="logEml" class="log"></div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
  /* ---------- helpers ---------- */
  const $ = id => document.getElementById(id);
  function log(boxId, txt){
    const el = $(boxId);
    el.insertAdjacentText('beforeend', txt + '\n');
    el.scrollTop = el.scrollHeight;
  }
  function downloadBlob(blob, name){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
  }
  function setProg(barId, pctId, pct){
    $(barId).style.width = pct + '%';
    $(pctId).textContent = pct + ' %';
  }

  /* ---------- zona com√∫n (click + drag) ---------- */
  function setupZone(zoneId, inputId, onFiles){
    const zone = $(zoneId);
    const inp  = $(inputId);

    // click normal
    inp.addEventListener('change', () => onFiles(inp.files));

    // drag
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
    zone.addEventListener('drop', e => {
      e.preventDefault(); zone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      inp.files = files; // pegar files al input
      onFiles(files);
    });
  }

  /* ---------- 1. LEFT ---------- */
  let bufLeft = [];
  setupZone('zoneLeft', 'pdfLeft', async files => {
    bufLeft = []; log('logLeft', ''); setProg('progLeft', 'pctLeft', 0);
    const total = files.length;
    for (let i = 0; i < total; i++){
      const f = files[i];
      const bytes = await f.arrayBuffer();
      const stamped = await stampPdf(bytes, f.name.replace(/\.pdf$/i, ''), 'left');
      bufLeft.push(stamped);
      setProg('progLeft', 'pctLeft', Math.round((i + 1) / total * 100));
      log('logLeft', `‚úî ${f.name}`);
    }
    log('logLeft', 'Listo. Pulsa DESCARGAR.');
  });
  $('#btnLeft').addEventListener('click', async () => {
    if (!bufLeft.length) { alert('Primero elige o arrastra PDFs'); return; }
    const merged = await mergePdfs(bufLeft);
    downloadBlob(merged, 'UNIDO_ROJO_IZQ.pdf');
    log('logLeft', '‚úÖ Descarga iniciada');
  });

  /* ---------- 2. CENTER ---------- */
  let bufCenter = [];
  setupZone('zoneCenter', 'pdfCenter', async files => {
    bufCenter = []; log('logCenter', ''); setProg('progCenter', 'pctCenter', 0);
    const total = files.length;
    for (let i = 0; i < total; i++){
      const f = files[i];
      const bytes = await f.arrayBuffer();
      const stamped = await stampPdf(bytes, f.name.replace(/\.pdf$/i, ''), 'center');
      bufCenter.push(stamped);
      setProg('progCenter', 'pctCenter', Math.round((i + 1) / total * 100));
      log('logCenter', `‚úî ${f.name}`);
    }
    log('logCenter', 'Listo. Pulsa DESCARGAR.');
  });
  $('#btnCenter').addEventListener('click', async () => {
    if (!bufCenter.length) { alert('Primero elige o arrastra PDFs'); return; }
    const merged = await mergePdfs(bufCenter);
    downloadBlob(merged, 'UNIDO_ROJO_CENTRADO.pdf');
    log('logCenter', '‚úÖ Descarga iniciada');
  });

  /* ---------- 3. ALL TO PDF ---------- */
  let bufAll = [];
  setupZone('zoneAll', 'allFiles', async files => {
    bufAll = []; log('logAll', ''); setProg('progAll', 'pctAll', 0);
    const total = files.length;
    for (let i = 0; i < total; i++){
      const f = files[i];
      const ext = f.name.split('.').pop().toLowerCase();
      let pdfBytes;
      try {
        if (ext === 'pdf') {
          pdfBytes = await f.arrayBuffer();
        } else if (['docx'].includes(ext)) {
          pdfBytes = await word2pdf(f);
        } else if (['jpg', 'jpeg', 'png'].includes(ext)) {
          pdfBytes = await img2pdf(f);
        } else if (ext === 'txt') {
          pdfBytes = await txt2pdf(f);
        } else {
          log('logAll', `‚ö† Saltado: ${f.name} (formato no soportado)`);
          continue;
        }
        const stamped = await stampPdf(pdfBytes, f.name.replace(/\.[^.]+$/i, ''), 'center');
        bufAll.push(stamped);
      } catch (err) {
        log('logAll', `‚ö† Error en ${f.name}: ${err.message}`);
      }
      setProg('progAll', 'pctAll', Math.round((i + 1) / total * 100));
      log('logAll', `‚úî ${f.name}`);
    }
    log('logAll', 'Listo. Pulsa DESCARGAR.');
  });
  $('#btnAll').addEventListener('click', async () => {
    if (!bufAll.length) { alert('Primero elige o arrastra archivos'); return; }
    const merged = await mergePdfs(bufAll);
    downloadBlob(merged, 'TODO_UNIDO_ROJO.pdf');
    log('logAll', '‚úÖ Descarga iniciada');
  });

  /* ---------- 4. CARPETA NUMERADA ---------- */
  let bufNum = [];
  setupZone('zoneNum', 'numFolder', async files => {
    bufNum = []; log('logNum', ''); setProg('progNum', 'pctNum', 0);
    const sorted = Array.from(files).sort((a, b) =>
      a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'})
    );
    const total = sorted.length;
    for (let i = 0; i < total; i++){
      const f = sorted[i];
      const ext = f.name.split('.').pop().toLowerCase();
      let pdfBytes;
      try {
        if (ext === 'pdf') {
          pdfBytes = await f.arrayBuffer();
        } else if (['docx'].includes(ext)) {
          pdfBytes = await word2pdf(f);
        } else if (['jpg', 'jpeg', 'png'].includes(ext)) {
          pdfBytes = await img2pdf(f);
        } else if (ext === 'txt') {
          pdfBytes = await txt2pdf(f);
        } else {
          log('logNum', `‚ö† Saltado: ${f.name}`);
          continue;
        }
        const newName = f.name.replace(/\.[^.]+$/, '.pdf');
        bufNum.push({name: newName, blob: new Blob([pdfBytes], {type: 'application/pdf'})});
      } catch (err) {
        log('logNum', `‚ö† Error en ${f.name}: ${err.message}`);
      }
      setProg('progNum', 'pctNum', Math.round((i + 1) / total * 100));
      log('logNum', `‚úî ${f.name}`);
    }
    const zip = new JSZip();
    bufNum.forEach(f => zip.file(f.name, f.blob));
    const content = await zip.generateAsync({type: 'blob'});
    downloadBlob(content, 'CARPETA_NUMERADA_PDFs.zip');
    log('logNum', '‚úÖ ZIP descargado');
  });

  /* ---------- 5. RENOMBRAR POR PATR√ìN ---------- */
  setupZone('zoneRename', 'renameFolder', async files => {
    log('logRename', ''); setProg('progRename', 'pctRename', 0);
    $('#btnRename').onclick = async () => {
      const pattern = $('#regexIn').value.trim();
      const repl = $('#replaceFmt').value.trim();
      let regex;
      try { regex = new RegExp(pattern, 'i'); } catch (e) {
        alert('Regex inv√°lido: ' + e.message); return;
      }
      const zip = new JSZip();
      const total = files.length;
      for (let i = 0; i < total; i++){
        const f = files[i];
        const name = f.name;
        const m = name.match(regex);
        if (!m) { log('logRename', `‚ö† Sin patr√≥n: ${name}`); continue; }
        let nuevo = repl;
        m.forEach((g, idx) => nuevo = nuevo.replaceAll('$' + idx, g || ''));
        const content = await f.arrayBuffer();
        zip.file(nuevo, content);
        log('logRename', `‚úî ${name}  ‚Üí  ${nuevo}`);
        setProg('progRename', 'pctRename', Math.round((i + 1) / total * 100));
      }
      const blob = await zip.generateAsync({type: 'blob'});
      downloadBlob(blob, 'CARPETA_RENOMBRADA.zip');
      log('logRename', '‚úÖ ZIP descargado');
    };
  });

  /* ---------- 6. EXTRAIR .eml ‚Üí EXCEL ---------- */
  setupZone('zoneEml', 'emlFolder', async files => {
    log('logEml', ''); setProg('progEml', 'pctEml', 0);
    const mailparser = await import('https://cdn.skypack.dev/mailparser');
    const XLSX = await import('https://cdn.skypack.dev/xlsx');
    const rows = [];
    const total = files.length;
    for (let i = 0; i < total; i++){
      const f = files[i];
      if (!f.name.toLowerCase().endsWith('.eml')) continue;
      try {
        const raw = await f.text();
        const msg = await mailparser.simpleParser(raw);
        rows.push({
          'Fecha': msg.date ? new Date(msg.date).toLocaleString('es-ES') : '',
          'Remitente': msg.from?.text || '',
          'Asunto': msg.subject || '',
          'Destinatario': Array.isArray(msg.to) ? msg.to.map(t => t.text).join('; ') : (msg.to?.text || ''),
          'Cuerpo de mail': (msg.text || '').replace(/\s+/g, ' ').substring(0, 32767),
          'Nombre de ficheros adjuntos': msg.attachments?.map(a => a.filename).join('; ') || ''
        });
        log('logEml', `‚úî ${f.name}`);
      } catch (e) {
        log('logEml', `‚ö† Error en ${f.name}: ${e.message}`);
      }
      setProg('progEml', 'pctEml', Math.round((i + 1) / total * 100));
    }
    if (!rows.length) { alert('No se encontraron .eml v√°lidos'); return; }
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Mails');
    const blob = XLSX.write(wb, {bookType: 'xlsx', type: 'blob'});
    downloadBlob(blob, 'Mails_desde_EML.xlsx');
    log('logEml', '‚úÖ Excel descargado');
  });

  /* ---------- core ---------- */
  async function stampPdf(pdfBytes, texto, align) {
    const pdf = await PDFLib.PDFDocument.load(pdfBytes);
    const font = await pdf.embedFont(PDFLib.StandardFonts.HelveticaBold);
    const txt = texto.toUpperCase().substring(0, 40);
    const fontSize = 10;
    const pages = pdf.getPages();
    pages.forEach(page => {
      const {width} = page.getSize();
      const textWidth = font.widthOfTextAtSize(txt, fontSize);
      const x = (align === 'left') ? 50 : (width - textWidth) / 2;
      page.drawText(txt, {x, y: page.getHeight() - 30, size: fontSize, font, color: {rgb: [1, 0, 0]}});
    });
    return await pdf.save();
  }
  async function mergePdfs(arrBytes) {
    const merged = await PDFLib.PDFDocument.create();
    for (const bytes of arrBytes) {
      const doc = await PDFLib.PDFDocument.load(bytes);
      const pages = await merged.copyPages(doc, doc.getPageIndices());
      pages.forEach(p => merged.addPage(p));
    }
    return new Blob([await merged.save()], {type: 'application/pdf'});
  }
  /* ---- conversores simples ---- */
  async function word2pdf(f) {
    const mod = await import('https://cdn.skypack.dev/docx2pdf.js');
    return await mod.default(await f.arrayBuffer());
  }
  async function img2pdf(f) {
    const img = await f.arrayBuffer();
    const pdf = await PDFLib.PDFDocument.create();
    let imgObj;
    if (f.name.toLowerCase().endsWith('.png')) imgObj = await pdf.embedPng(img);
    else imgObj = await pdf.embedJpg(img);
    const page = pdf.addPage([imgObj.width, imgObj.height]);
    page.drawImage(imgObj, {x: 0, y: 0, width: imgObj.width, height: imgObj.height});
    return await pdf.save();
  }
  async function txt2pdf(f) {
    const text = await f.text();
    const pdf = await PDFLib.PDFDocument.create();
    const font = await pdf.embedFont(PDFLib.StandardFonts.Helvetica);
    const fontSize = 12;
    const lineHeight = fontSize + 4;
    let page = pdf.addPage();
    let y = page.getHeight() - 50;
    text.split('\n').forEach(line => {
      if (y < 50) { page = pdf.addPage(); y = page.getHeight() - 50; }
      page.drawText(line, {x: 50, y, size: fontSize, font});
      y -= lineHeight;
    });
    return await pdf.save();
  }
  </script>
</body>
</html>
